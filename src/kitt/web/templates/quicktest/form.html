{% extends "base.html" %}
{% block title %}KITT - New Quick Test{% endblock %}

{% block content %}
<div x-data="quickTest()" class="space-y-6 max-w-3xl" x-init="loadModels()">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold">New Quick Test</h1>
            <p class="text-kitt-dim text-sm mt-1">Run a single benchmark quickly on an agent</p>
        </div>
        <a href="/quicktest" class="text-kitt-dim hover:text-white text-sm transition-colors">&larr; Back to history</a>
    </div>

    <div class="bg-kitt-surface rounded-lg p-6 space-y-4">
        <!-- Agent -->
        <div>
            <label class="block text-sm text-kitt-dim mb-1">Agent</label>
            <select x-model="form.agent_id"
                    class="w-full bg-kitt-bg border border-kitt-primary/50 rounded-md px-4 py-2 text-sm focus:outline-none focus:border-kitt-accent">
                <option value="">Select an agent...</option>
                {% for agent in agents %}
                <option value="{{ agent.id }}">{{ agent.name }} ({{ agent.gpu_info or 'no GPU info' }})</option>
                {% endfor %}
            </select>
        </div>

        <!-- Model (searchable combobox) -->
        <div x-data="modelCombobox()" class="relative">
            <label class="block text-sm text-kitt-dim mb-1">Model</label>
            <input type="text"
                   x-model="search"
                   @input="open = true"
                   @focus="open = true"
                   @click="open = true"
                   @keydown.escape="open = false"
                   @keydown.arrow-down.prevent="highlightNext()"
                   @keydown.arrow-up.prevent="highlightPrev()"
                   @keydown.enter.prevent="selectHighlighted()"
                   placeholder="Search models or enter a custom path..."
                   class="w-full bg-kitt-bg border border-kitt-primary/50 rounded-md px-4 py-2 text-sm focus:outline-none focus:border-kitt-accent">

            <!-- Dropdown -->
            <div x-show="open && filtered.length > 0"
                 x-cloak
                 @click.outside="open = false"
                 class="absolute z-10 mt-1 w-full bg-kitt-bg border border-kitt-primary/50 rounded-md shadow-lg max-h-60 overflow-y-auto">
                <template x-for="(model, idx) in filtered" :key="model.model_id">
                    <div @click="selectModel(model)"
                         @mouseenter="highlighted = idx"
                         :class="{ 'bg-kitt-accent/20': highlighted === idx }"
                         class="px-4 py-2 cursor-pointer hover:bg-kitt-accent/10 text-sm">
                        <div class="flex items-center gap-2">
                            <span x-text="model.model_id" class="font-medium"></span>
                            <template x-for="fmt in (model.formats || [])" :key="fmt">
                                <span x-text="fmt" class="text-[10px] px-1.5 py-0.5 rounded bg-kitt-accent/20 text-kitt-accent"></span>
                            </template>
                        </div>
                        <div class="text-xs text-kitt-dim flex gap-3">
                            <span x-text="model.source"></span>
                            <span x-text="formatSize(model.size_bytes)"></span>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- Engine -->
        <div>
            <label class="block text-sm text-kitt-dim mb-1">Engine</label>
            <select x-model="form.engine_name"
                    class="w-full bg-kitt-bg border border-kitt-primary/50 rounded-md px-4 py-2 text-sm focus:outline-none focus:border-kitt-accent">
                <option value="vllm">vLLM</option>
                <option value="tgi">TGI</option>
                <option value="llama_cpp">llama.cpp</option>
                <option value="ollama">Ollama</option>
            </select>
        </div>

        <!-- Benchmark -->
        <div>
            <label class="block text-sm text-kitt-dim mb-1">Benchmark</label>
            <select x-model="form.benchmark_name"
                    class="w-full bg-kitt-bg border border-kitt-primary/50 rounded-md px-4 py-2 text-sm focus:outline-none focus:border-kitt-accent">
                <option value="throughput">Throughput</option>
                <option value="latency">Latency</option>
                <option value="memory_usage">Memory Usage</option>
                <option value="mmlu">MMLU</option>
                <option value="gsm8k">GSM8K</option>
            </select>
        </div>

        <button @click="launch()" :disabled="launching"
                class="w-full bg-kitt-accent hover:bg-kitt-accent/80 disabled:opacity-50 text-white px-6 py-2.5 rounded-md text-sm font-medium transition-colors">
            <span x-show="!launching">Run Test</span>
            <span x-show="launching">Launching...</span>
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function quickTest() {
    return {
        form: {
            agent_id: '',
            model_path: '',
            engine_name: 'vllm',
            benchmark_name: 'throughput',
        },
        allModels: [],
        engineFormats: {},
        launching: false,

        async loadModels() {
            try {
                const [modelsResp, formatsResp] = await Promise.all([
                    fetch('/api/v1/quicktest/models'),
                    fetch('/api/v1/quicktest/engine-formats'),
                ]);
                this.allModels = await modelsResp.json();
                this.engineFormats = await formatsResp.json();
            } catch (e) {
                console.warn('Failed to load models/formats:', e);
            }
        },

        async launch() {
            this.launching = true;

            // Use search text as model_path if not set by combobox selection
            if (!this.form.model_path) {
                this.form.model_path = document.querySelector('[x-data="modelCombobox()"] input')?.value || '';
            }

            try {
                const resp = await fetch('/api/v1/quicktest/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(this.form),
                });
                const data = await resp.json();
                if (data.id) {
                    window.location = '/quicktest/' + data.id;
                } else {
                    alert(data.error || 'Failed to launch test');
                    this.launching = false;
                }
            } catch (e) {
                alert('Failed to connect to server: ' + e.message);
                this.launching = false;
            }
        },
    };
}

function modelCombobox() {
    return {
        search: '',
        open: false,
        highlighted: 0,

        get filtered() {
            const q = this.search.toLowerCase();
            let models = this.$data.allModels || [];

            // Filter by engine format compatibility
            const engine = this.$data.form?.engine_name;
            const engineFmts = this.$data.engineFormats || {};
            const supported = engine && engineFmts[engine];
            if (supported && supported.length) {
                models = models.filter(m => {
                    if (!m.formats || !m.formats.length) return true;
                    return m.formats.some(f => supported.includes(f));
                });
            }

            if (!q) return models;
            return models.filter(m =>
                m.model_id.toLowerCase().includes(q)
            );
        },

        selectModel(model) {
            this.search = model.model_id;
            this.open = false;
            // Set the parent form's model_path
            this.$data.form.model_path = model.path;
        },

        selectHighlighted() {
            if (this.filtered.length > 0 && this.highlighted < this.filtered.length) {
                this.selectModel(this.filtered[this.highlighted]);
            } else {
                // Manual entry â€” use search text as model_path
                this.$data.form.model_path = this.search;
                this.open = false;
            }
        },

        highlightNext() {
            if (this.highlighted < this.filtered.length - 1) {
                this.highlighted++;
            }
        },

        highlightPrev() {
            if (this.highlighted > 0) {
                this.highlighted--;
            }
        },

        formatSize(bytes) {
            if (!bytes) return '';
            const gb = bytes / (1024 * 1024 * 1024);
            return gb >= 1 ? gb.toFixed(1) + ' GB' : (bytes / (1024 * 1024)).toFixed(0) + ' MB';
        },
    };
}
</script>
{% endblock %}
