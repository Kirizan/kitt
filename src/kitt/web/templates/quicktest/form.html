{% extends "base.html" %}
{% block title %}KITT - Quick Test{% endblock %}

{% block content %}
<div x-data="quickTest()" class="space-y-6 max-w-3xl">
    <div>
        <h1 class="text-2xl font-bold">Quick Test</h1>
        <p class="text-kitt-dim text-sm mt-1">Run a single benchmark quickly on an agent</p>
    </div>

    <div class="bg-kitt-surface rounded-lg p-6 space-y-4">
        <!-- Agent -->
        <div>
            <label class="block text-sm text-kitt-dim mb-1">Agent</label>
            <select x-model="form.agent_id"
                    class="w-full bg-kitt-bg border border-kitt-primary/50 rounded-md px-4 py-2 text-sm focus:outline-none focus:border-kitt-accent">
                <option value="">Select an agent...</option>
                {% for agent in agents %}
                <option value="{{ agent.id }}">{{ agent.name }} ({{ agent.gpu_info or 'no GPU info' }})</option>
                {% endfor %}
            </select>
        </div>

        <!-- Model -->
        <div>
            <label class="block text-sm text-kitt-dim mb-1">Model Path</label>
            <input type="text" x-model="form.model_path" placeholder="e.g., meta-llama/Llama-3-8B or /path/to/model"
                   class="w-full bg-kitt-bg border border-kitt-primary/50 rounded-md px-4 py-2 text-sm focus:outline-none focus:border-kitt-accent">
        </div>

        <!-- Engine -->
        <div>
            <label class="block text-sm text-kitt-dim mb-1">Engine</label>
            <select x-model="form.engine_name"
                    class="w-full bg-kitt-bg border border-kitt-primary/50 rounded-md px-4 py-2 text-sm focus:outline-none focus:border-kitt-accent">
                <option value="vllm">vLLM</option>
                <option value="tgi">TGI</option>
                <option value="llama_cpp">llama.cpp</option>
                <option value="ollama">Ollama</option>
            </select>
        </div>

        <!-- Benchmark -->
        <div>
            <label class="block text-sm text-kitt-dim mb-1">Benchmark</label>
            <select x-model="form.benchmark_name"
                    class="w-full bg-kitt-bg border border-kitt-primary/50 rounded-md px-4 py-2 text-sm focus:outline-none focus:border-kitt-accent">
                <option value="throughput">Throughput</option>
                <option value="latency">Latency</option>
                <option value="memory_usage">Memory Usage</option>
                <option value="mmlu">MMLU</option>
                <option value="gsm8k">GSM8K</option>
            </select>
        </div>

        <button @click="launch()" :disabled="running"
                class="w-full bg-kitt-accent hover:bg-kitt-accent/80 disabled:opacity-50 text-white px-6 py-2.5 rounded-md text-sm font-medium transition-colors">
            <span x-show="!running">Run Test</span>
            <span x-show="running">Running...</span>
        </button>
    </div>

    <!-- Live output -->
    <div x-show="testId" class="bg-kitt-surface rounded-lg p-5">
        <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-semibold">Output</h2>
            <span x-text="status" class="text-xs px-2 py-0.5 rounded bg-blue-900/50 text-blue-300"></span>
        </div>
        <div id="test-log" class="bg-kitt-bg rounded-md p-4 h-64 overflow-y-auto font-mono text-xs text-kitt-dim">
            <p>Waiting for output...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function quickTest() {
    return {
        form: {
            agent_id: '',
            model_path: '',
            engine_name: 'vllm',
            benchmark_name: 'throughput',
        },
        running: false,
        testId: null,
        status: '',
        async launch() {
            this.running = true;
            const resp = await fetch('/api/v1/quicktest/', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(this.form),
            });
            const data = await resp.json();
            if (data.id) {
                this.testId = data.id;
                this.status = data.status;
                this.pollStatus();
            } else {
                alert(data.error || 'Failed to launch test');
                this.running = false;
            }
        },
        async pollStatus() {
            if (!this.testId) return;
            const resp = await fetch('/api/v1/quicktest/' + this.testId);
            const data = await resp.json();
            this.status = data.status;
            if (data.status === 'queued' || data.status === 'running') {
                setTimeout(() => this.pollStatus(), 2000);
            } else {
                this.running = false;
            }
        }
    };
}
</script>
{% endblock %}
