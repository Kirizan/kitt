{% extends "base.html" %}
{% block title %}KITT - Create Campaign{% endblock %}

{% block content %}
<div x-data="campaignWizard()" class="space-y-6 max-w-4xl">
    <div>
        <h1 class="text-2xl font-bold">Create Campaign</h1>
        <p class="text-kitt-dim text-sm mt-1">Configure and launch a benchmark campaign</p>
    </div>

    <!-- Step indicators -->
    <div class="flex items-center space-x-2">
        <template x-for="(s, i) in steps" :key="i">
            <div class="flex items-center">
                <div :class="i <= step ? 'bg-kitt-accent text-white' : 'bg-kitt-surface text-kitt-dim'"
                     class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium">
                    <span x-text="i + 1"></span>
                </div>
                <span :class="i <= step ? 'text-white' : 'text-kitt-dim'"
                      class="text-xs ml-2 hidden sm:inline" x-text="s"></span>
                <div x-show="i < steps.length - 1" class="w-8 h-px bg-kitt-primary mx-2"></div>
            </div>
        </template>
    </div>

    <!-- Step 1: Basics -->
    <div x-show="step === 0" class="bg-kitt-surface rounded-lg p-6 space-y-4">
        <h2 class="text-lg font-semibold">Campaign Basics</h2>
        <div>
            <label class="block text-sm text-kitt-dim mb-1">Name</label>
            <input type="text" x-model="form.name" placeholder="e.g., Llama 3 Performance Sweep"
                   class="w-full bg-kitt-bg border border-kitt-primary/50 rounded-md px-4 py-2 text-sm focus:outline-none focus:border-kitt-accent">
        </div>
        <div>
            <label class="block text-sm text-kitt-dim mb-1">Description</label>
            <textarea x-model="form.description" rows="3" placeholder="Optional description..."
                      class="w-full bg-kitt-bg border border-kitt-primary/50 rounded-md px-4 py-2 text-sm focus:outline-none focus:border-kitt-accent"></textarea>
        </div>
    </div>

    <!-- Step 2: Models -->
    <div x-show="step === 1" class="bg-kitt-surface rounded-lg p-6 space-y-4">
        <h2 class="text-lg font-semibold">Models</h2>
        <p class="text-kitt-dim text-sm">Add models to benchmark. Enter HuggingFace repo IDs or local paths.</p>
        <div class="space-y-2">
            <template x-for="(model, i) in form.models" :key="i">
                <div class="flex gap-2">
                    <input type="text" x-model="form.models[i].name" placeholder="Model repo ID or path"
                           class="flex-1 bg-kitt-bg border border-kitt-primary/50 rounded-md px-4 py-2 text-sm focus:outline-none focus:border-kitt-accent">
                    <button @click="form.models.splice(i, 1)" class="text-red-400 hover:text-red-300 px-2">&times;</button>
                </div>
            </template>
        </div>
        <button @click="form.models.push({name: ''})" class="text-kitt-accent hover:underline text-sm">+ Add model</button>
    </div>

    <!-- Step 3: Engines -->
    <div x-show="step === 2" class="bg-kitt-surface rounded-lg p-6 space-y-4">
        <h2 class="text-lg font-semibold">Engines</h2>
        <p class="text-kitt-dim text-sm">Select inference engines to test with.</p>
        <div class="grid grid-cols-2 gap-3">
            {% set engine_list = ['vllm', 'tgi', 'llama_cpp', 'ollama'] %}
            {% for eng in engine_list %}
            <label class="flex items-center space-x-2 bg-kitt-bg rounded-md p-3 cursor-pointer hover:bg-kitt-primary/30">
                <input type="checkbox" value="{{ eng }}" x-model="form.engines"
                       class="rounded border-kitt-primary text-kitt-accent focus:ring-kitt-accent">
                <span class="text-sm">{{ eng }}</span>
            </label>
            {% endfor %}
        </div>
    </div>

    <!-- Step 4: Settings -->
    <div x-show="step === 3" class="bg-kitt-surface rounded-lg p-6 space-y-4">
        <h2 class="text-lg font-semibold">Settings</h2>
        <div>
            <label class="block text-sm text-kitt-dim mb-1">Suite</label>
            <select x-model="form.suite"
                    class="bg-kitt-bg border border-kitt-primary/50 rounded-md px-4 py-2 text-sm focus:outline-none focus:border-kitt-accent">
                <option value="quick">Quick</option>
                <option value="standard">Standard</option>
                <option value="performance">Performance</option>
            </select>
        </div>
        <label class="flex items-center space-x-2">
            <input type="checkbox" x-model="form.devon_managed"
                   class="rounded border-kitt-primary text-kitt-accent focus:ring-kitt-accent">
            <span class="text-sm">Use Devon for model management</span>
        </label>
        <label class="flex items-center space-x-2">
            <input type="checkbox" x-model="form.cleanup_after_run"
                   class="rounded border-kitt-primary text-kitt-accent focus:ring-kitt-accent">
            <span class="text-sm">Clean up models after each run</span>
        </label>
    </div>

    <!-- Step 5: Agent -->
    <div x-show="step === 4" class="bg-kitt-surface rounded-lg p-6 space-y-4">
        <h2 class="text-lg font-semibold">Agent</h2>
        <p class="text-kitt-dim text-sm">Select the agent to run this campaign on.</p>
        {% if agents %}
        <div class="space-y-2">
            {% for agent in agents %}
            <label class="flex items-center justify-between bg-kitt-bg rounded-md p-3 cursor-pointer hover:bg-kitt-primary/30">
                <div class="flex items-center space-x-3">
                    <input type="radio" name="agent" value="{{ agent.id }}" x-model="form.agent_id"
                           class="border-kitt-primary text-kitt-accent focus:ring-kitt-accent">
                    <div>
                        <div class="text-sm font-medium">{{ agent.name }}</div>
                        <div class="text-xs text-kitt-dim">{{ agent.gpu_info or 'No GPU info' }}</div>
                    </div>
                </div>
                <span class="w-2 h-2 rounded-full
                      {% if agent.status == 'online' %}bg-green-400{% else %}bg-gray-500{% endif %}"></span>
            </label>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-kitt-dim text-sm">No agents available. <a href="/agents/add" class="text-kitt-accent hover:underline">Add an agent first.</a></p>
        {% endif %}
    </div>

    <!-- Step 6: Review -->
    <div x-show="step === 5" class="bg-kitt-surface rounded-lg p-6 space-y-4">
        <h2 class="text-lg font-semibold">Review</h2>
        <dl class="space-y-3 text-sm">
            <div class="flex justify-between"><dt class="text-kitt-dim">Name</dt><dd x-text="form.name"></dd></div>
            <div class="flex justify-between"><dt class="text-kitt-dim">Models</dt><dd x-text="form.models.map(m => m.name).filter(Boolean).join(', ') || 'None'"></dd></div>
            <div class="flex justify-between"><dt class="text-kitt-dim">Engines</dt><dd x-text="form.engines.join(', ') || 'None'"></dd></div>
            <div class="flex justify-between"><dt class="text-kitt-dim">Suite</dt><dd x-text="form.suite"></dd></div>
            <div class="flex justify-between"><dt class="text-kitt-dim">Agent</dt><dd x-text="form.agent_id || 'Not selected'"></dd></div>
        </dl>
    </div>

    <!-- Navigation buttons -->
    <div class="flex justify-between">
        <button @click="step = Math.max(0, step - 1)" x-show="step > 0"
                class="bg-kitt-surface hover:bg-kitt-primary text-white px-6 py-2 rounded-md text-sm transition-colors">
            Back
        </button>
        <div class="ml-auto flex gap-3">
            <button x-show="step < steps.length - 1" @click="step++"
                    class="bg-kitt-accent hover:bg-kitt-accent/80 text-white px-6 py-2 rounded-md text-sm font-medium transition-colors">
                Next
            </button>
            <button x-show="step === steps.length - 1" @click="submitCampaign()"
                    class="bg-green-600 hover:bg-green-500 text-white px-6 py-2 rounded-md text-sm font-medium transition-colors">
                Create Campaign
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function campaignWizard() {
    return {
        step: 0,
        steps: ['Basics', 'Models', 'Engines', 'Settings', 'Agent', 'Review'],
        form: {
            name: '',
            description: '',
            models: [{name: ''}],
            engines: [],
            suite: 'quick',
            agent_id: '',
            devon_managed: true,
            cleanup_after_run: true,
        },
        async submitCampaign() {
            const config = {
                models: this.form.models.filter(m => m.name),
                engines: this.form.engines.map(e => ({name: e})),
                suite: this.form.suite,
                devon_managed: this.form.devon_managed,
                cleanup_after_run: this.form.cleanup_after_run,
            };
            const resp = await fetch('/api/v1/campaigns/', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    name: this.form.name,
                    description: this.form.description,
                    config: config,
                    agent_id: this.form.agent_id,
                }),
            });
            const data = await resp.json();
            if (data.id) {
                window.location.href = '/campaigns/' + data.id;
            }
        }
    };
}
</script>
{% endblock %}
