{% extends "base.html" %}
{% block title %}KITT - Create Campaign{% endblock %}

{% block content %}
<div x-data="campaignWizard()" class="space-y-6 max-w-4xl" x-init="loadData()">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold">Create Campaign</h1>
            <p class="text-kitt-dim text-sm mt-1">Configure and launch a benchmark campaign</p>
        </div>
        <a href="/campaigns" class="text-kitt-dim hover:text-white text-sm transition-colors">&larr; Back to campaigns</a>
    </div>

    <!-- Step indicators -->
    <div class="flex items-center space-x-2">
        <template x-for="(s, i) in steps" :key="i">
            <div class="flex items-center">
                <div :class="i <= step ? 'bg-kitt-accent text-white' : 'bg-kitt-surface text-kitt-dim'"
                     class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium">
                    <span x-text="i + 1"></span>
                </div>
                <span :class="i <= step ? 'text-white' : 'text-kitt-dim'"
                      class="text-xs ml-2 hidden sm:inline" x-text="s"></span>
                <div x-show="i < steps.length - 1" class="w-8 h-px bg-kitt-primary mx-2"></div>
            </div>
        </template>
    </div>

    <!-- Step 1: Basics -->
    <div x-show="step === 0" class="bg-kitt-surface rounded-lg p-6 space-y-4">
        <h2 class="text-lg font-semibold">Campaign Basics</h2>
        <div>
            <label class="block text-sm text-kitt-dim mb-1">Name</label>
            <input type="text" x-model="form.name" placeholder="e.g., Llama 3 Performance Sweep"
                   class="w-full bg-kitt-bg border border-kitt-primary/50 rounded-md px-4 py-2 text-sm focus:outline-none focus:border-kitt-accent">
        </div>
        <div>
            <label class="block text-sm text-kitt-dim mb-1">Description</label>
            <textarea x-model="form.description" rows="3" placeholder="Optional description..."
                      class="w-full bg-kitt-bg border border-kitt-primary/50 rounded-md px-4 py-2 text-sm focus:outline-none focus:border-kitt-accent"></textarea>
        </div>
    </div>

    <!-- Step 2: Agent -->
    <div x-show="step === 1" class="bg-kitt-surface rounded-lg p-6 space-y-4">
        <h2 class="text-lg font-semibold">Agent</h2>
        <p class="text-kitt-dim text-sm">Select the agent to run this campaign on. This determines which engines are compatible.</p>
        {% if agents %}
        <div class="space-y-2">
            {% for agent in agents %}
            <label @click="onAgentChange('{{ agent.id }}')"
                   class="flex items-center justify-between bg-kitt-bg rounded-md p-3 cursor-pointer hover:bg-kitt-primary/30 transition-colors"
                   :class="{ 'ring-1 ring-kitt-accent': form.agent_id === '{{ agent.id }}' }">
                <div class="flex items-center space-x-3">
                    <input type="radio" name="agent" value="{{ agent.id }}" x-model="form.agent_id"
                           class="border-kitt-primary text-kitt-accent focus:ring-kitt-accent">
                    <div>
                        <div class="text-sm font-medium">{{ agent.name }}</div>
                        <div class="text-xs text-kitt-dim">{{ agent.gpu_info or 'No GPU info' }} &middot; {{ agent.cpu_arch or 'unknown arch' }}</div>
                    </div>
                </div>
                <span class="w-2 h-2 rounded-full
                      {% if agent.status == 'online' %}bg-green-400{% else %}bg-gray-500{% endif %}"></span>
            </label>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-kitt-dim text-sm">No agents available. <a href="/agents/add" class="text-kitt-accent hover:underline">Add an agent first.</a></p>
        {% endif %}
    </div>

    <!-- Step 3: Engines -->
    <div x-show="step === 2" class="bg-kitt-surface rounded-lg p-6 space-y-4">
        <h2 class="text-lg font-semibold">Engines</h2>
        <p class="text-kitt-dim text-sm">Select inference engines to test with.</p>

        <template x-if="!form.agent_id">
            <p class="text-yellow-400 text-sm">Select an agent first to see engine compatibility.</p>
        </template>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <template x-for="eng in availableEngines" :key="eng.name">
                <label class="flex items-start space-x-3 bg-kitt-bg rounded-md p-3 transition-colors"
                       :class="{
                           'cursor-pointer hover:bg-kitt-primary/30': eng.compatible || overrideCompat,
                           'opacity-50 cursor-not-allowed': !eng.compatible && !overrideCompat,
                           'ring-1 ring-kitt-accent': form.engines.includes(eng.name)
                       }">
                    <input type="checkbox" :value="eng.name" x-model="form.engines"
                           :disabled="!eng.compatible && !overrideCompat"
                           class="mt-0.5 rounded border-kitt-primary text-kitt-accent focus:ring-kitt-accent">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2">
                            <span class="text-sm font-medium" x-text="eng.label"></span>
                            <template x-for="fmt in eng.formats" :key="fmt">
                                <span x-text="fmt" class="text-[10px] px-1.5 py-0.5 rounded bg-kitt-accent/20 text-kitt-accent"></span>
                            </template>
                        </div>
                        <template x-if="!eng.compatible">
                            <p class="text-xs text-red-400 mt-0.5" x-text="eng.reason"></p>
                        </template>
                    </div>
                </label>
            </template>
        </div>

        <div class="flex items-center gap-2 pt-2">
            <input type="checkbox" id="override-compat" x-model="overrideCompat"
                   class="rounded border-kitt-primary/50 bg-kitt-bg text-kitt-accent focus:ring-kitt-accent">
            <label for="override-compat" class="text-xs text-kitt-dim">
                Show all engines (override compatibility filtering)
            </label>
        </div>
    </div>

    <!-- Step 4: Models -->
    <div x-show="step === 3" class="bg-kitt-surface rounded-lg p-6 space-y-4">
        <h2 class="text-lg font-semibold">Models</h2>
        <p class="text-kitt-dim text-sm">Select models to benchmark. Models are filtered by selected engines' supported formats.</p>

        <!-- Search filter -->
        <input type="text" x-model="modelSearch" placeholder="Filter models..."
               class="w-full bg-kitt-bg border border-kitt-primary/50 rounded-md px-4 py-2 text-sm focus:outline-none focus:border-kitt-accent">

        <!-- Model list -->
        <div class="max-h-80 overflow-y-auto space-y-1">
            <template x-if="filteredModels.length === 0">
                <p class="text-kitt-dim text-sm py-4 text-center">No compatible models found.</p>
            </template>
            <template x-for="model in filteredModels" :key="model.model_id">
                <label class="flex items-center gap-3 bg-kitt-bg rounded-md p-3 cursor-pointer hover:bg-kitt-primary/30 transition-colors"
                       :class="{ 'ring-1 ring-kitt-accent': selectedModelIds.includes(model.model_id) }">
                    <input type="checkbox" :value="model.model_id"
                           :checked="selectedModelIds.includes(model.model_id)"
                           @change="toggleModel(model)"
                           class="rounded border-kitt-primary text-kitt-accent focus:ring-kitt-accent">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 flex-wrap">
                            <span class="text-sm font-medium truncate" x-text="model.model_id"></span>
                            <template x-for="fmt in (model.formats || [])" :key="fmt">
                                <span x-text="fmt" class="text-[10px] px-1.5 py-0.5 rounded bg-kitt-accent/20 text-kitt-accent"></span>
                            </template>
                        </div>
                        <div class="text-xs text-kitt-dim flex gap-3 mt-0.5">
                            <span x-text="model.source"></span>
                            <span x-text="formatSize(model.size_bytes)"></span>
                        </div>
                    </div>
                </label>
            </template>
        </div>

        <!-- Custom model path -->
        <div class="border-t border-kitt-primary/30 pt-4">
            <label class="block text-sm text-kitt-dim mb-1">Add custom model path</label>
            <div class="flex gap-2">
                <input type="text" x-model="customModelPath" placeholder="HuggingFace repo ID or local path..."
                       class="flex-1 bg-kitt-bg border border-kitt-primary/50 rounded-md px-4 py-2 text-sm focus:outline-none focus:border-kitt-accent">
                <button @click="addCustomModel()" :disabled="!customModelPath.trim()"
                        class="bg-kitt-accent hover:bg-kitt-accent/80 disabled:opacity-50 text-white px-4 py-2 rounded-md text-sm transition-colors">
                    Add
                </button>
            </div>
        </div>

        <!-- Selected count -->
        <div class="text-xs text-kitt-dim">
            <span x-text="selectedModels.length"></span> model(s) selected
        </div>
    </div>

    <!-- Step 5: Settings -->
    <div x-show="step === 4" class="bg-kitt-surface rounded-lg p-6 space-y-4">
        <h2 class="text-lg font-semibold">Settings</h2>
        <div>
            <label class="block text-sm text-kitt-dim mb-1">Suite</label>
            <select x-model="form.suite"
                    class="bg-kitt-bg border border-kitt-primary/50 rounded-md px-4 py-2 text-sm focus:outline-none focus:border-kitt-accent">
                <option value="quick">Quick</option>
                <option value="standard">Standard</option>
                <option value="performance">Performance</option>
            </select>
        </div>
        <label class="flex items-center space-x-2">
            <input type="checkbox" x-model="form.devon_managed"
                   class="rounded border-kitt-primary text-kitt-accent focus:ring-kitt-accent">
            <span class="text-sm">Use Devon for model management</span>
        </label>
        <label class="flex items-center space-x-2">
            <input type="checkbox" x-model="form.cleanup_after_run"
                   class="rounded border-kitt-primary text-kitt-accent focus:ring-kitt-accent">
            <span class="text-sm">Clean up models after each run</span>
        </label>
    </div>

    <!-- Step 6: Review -->
    <div x-show="step === 5" class="bg-kitt-surface rounded-lg p-6 space-y-6">
        <h2 class="text-lg font-semibold">Review</h2>

        <!-- Summary -->
        <dl class="space-y-3 text-sm">
            <div class="flex justify-between"><dt class="text-kitt-dim">Name</dt><dd x-text="form.name"></dd></div>
            <div class="flex justify-between"><dt class="text-kitt-dim">Agent</dt><dd x-text="agentName || 'Not selected'"></dd></div>
            <div class="flex justify-between"><dt class="text-kitt-dim">Engines</dt><dd x-text="form.engines.map(e => ENGINE_LABELS[e] || e).join(', ') || 'None'"></dd></div>
            <div class="flex justify-between"><dt class="text-kitt-dim">Models</dt><dd x-text="selectedModels.length + ' selected'"></dd></div>
            <div class="flex justify-between"><dt class="text-kitt-dim">Suite</dt><dd x-text="form.suite"></dd></div>
        </dl>

        <!-- Compatibility matrix -->
        <template x-if="selectedModels.length > 0 && form.engines.length > 0">
            <div>
                <h3 class="text-sm font-semibold mb-2">Compatibility Matrix</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="text-kitt-dim text-left">
                                <th class="px-3 py-2 font-medium">Model</th>
                                <template x-for="eng in form.engines" :key="eng">
                                    <th class="px-3 py-2 font-medium text-center" x-text="ENGINE_LABELS[eng] || eng"></th>
                                </template>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-kitt-primary/20">
                            <template x-for="model in selectedModels" :key="model.model_id">
                                <tr>
                                    <td class="px-3 py-2 truncate max-w-[200px]" :title="model.model_id" x-text="model.model_id"></td>
                                    <template x-for="eng in form.engines" :key="eng">
                                        <td class="px-3 py-2 text-center">
                                            <template x-if="isCompatible(model, eng)">
                                                <span class="text-green-400">&#10003;</span>
                                            </template>
                                            <template x-if="!isCompatible(model, eng)">
                                                <span class="text-red-400">&#10007;</span>
                                            </template>
                                        </td>
                                    </template>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
                <p class="text-xs text-kitt-dim mt-2">
                    <span class="text-green-400">&#10003;</span> = model format matches engine,
                    <span class="text-red-400">&#10007;</span> = incompatible format (run will be skipped)
                </p>
            </div>
        </template>
    </div>

    <!-- Navigation buttons -->
    <div class="flex justify-between">
        <button @click="step = Math.max(0, step - 1)" x-show="step > 0"
                class="bg-kitt-surface hover:bg-kitt-primary text-white px-6 py-2 rounded-md text-sm transition-colors">
            Back
        </button>
        <div class="ml-auto flex gap-3">
            <button x-show="step < steps.length - 1" @click="step++"
                    :disabled="!canAdvance"
                    class="bg-kitt-accent hover:bg-kitt-accent/80 disabled:opacity-50 text-white px-6 py-2 rounded-md text-sm font-medium transition-colors">
                Next
            </button>
            <button x-show="step === steps.length - 1" @click="submitCampaign()" :disabled="submitting"
                    class="bg-green-600 hover:bg-green-500 disabled:opacity-50 text-white px-6 py-2 rounded-md text-sm font-medium transition-colors">
                <span x-show="!submitting">Create Campaign</span>
                <span x-show="submitting">Creating...</span>
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const ENGINE_LABELS = {
    vllm: 'vLLM',
    tgi: 'TGI',
    llama_cpp: 'llama.cpp',
    ollama: 'Ollama',
    exllamav2: 'ExLlamaV2',
    mlx: 'MLX',
};

function campaignWizard() {
    return {
        step: 0,
        steps: ['Basics', 'Agent', 'Engines', 'Models', 'Settings', 'Review'],
        form: {
            name: '',
            description: '',
            agent_id: '',
            engines: [],
            suite: 'quick',
            devon_managed: true,
            cleanup_after_run: true,
        },
        allModels: [],
        engineFormats: {},
        agentCapabilities: {},
        overrideCompat: false,
        modelSearch: '',
        customModelPath: '',
        selectedModels: [],
        submitting: false,

        async loadData() {
            try {
                const [modelsResp, formatsResp, capsResp] = await Promise.all([
                    fetch('/api/v1/quicktest/models'),
                    fetch('/api/v1/quicktest/engine-formats'),
                    fetch('/api/v1/quicktest/agent-capabilities'),
                ]);
                this.allModels = await modelsResp.json();
                this.engineFormats = await formatsResp.json();
                this.agentCapabilities = await capsResp.json();
            } catch (e) {
                console.warn('Failed to load data:', e);
            }
        },

        onAgentChange(agentId) {
            this.form.agent_id = agentId;
            // Remove incompatible engines from selection
            if (!this.overrideCompat) {
                const caps = this.agentCapabilities[agentId];
                const engineEntries = caps ? caps.engines : {};
                this.form.engines = this.form.engines.filter(name => {
                    const compat = engineEntries[name];
                    return compat ? compat.compatible : true;
                });
            }
        },

        get availableEngines() {
            const caps = this.agentCapabilities[this.form.agent_id];
            const engineEntries = caps ? caps.engines : {};

            const engines = [];
            for (const [name, formats] of Object.entries(this.engineFormats)) {
                const compat = engineEntries[name];
                const compatible = compat ? compat.compatible : true;
                const reason = compat && !compatible ? compat.reason : '';
                engines.push({
                    name,
                    label: ENGINE_LABELS[name] || name,
                    formats,
                    compatible,
                    reason,
                });
            }

            // Compatible engines first
            engines.sort((a, b) => {
                if (a.compatible !== b.compatible) return a.compatible ? -1 : 1;
                return 0;
            });

            return engines;
        },

        get selectedEngineFormats() {
            // Collect all formats supported by any selected engine
            const formats = new Set();
            for (const eng of this.form.engines) {
                const fmts = this.engineFormats[eng] || [];
                fmts.forEach(f => formats.add(f));
            }
            return formats;
        },

        get filteredModels() {
            const q = this.modelSearch.toLowerCase();
            let models = this.allModels;

            // Filter by engine format compatibility (unless override is on)
            if (!this.overrideCompat && this.form.engines.length > 0) {
                const supported = this.selectedEngineFormats;
                if (supported.size > 0) {
                    models = models.filter(m => {
                        if (!m.formats || !m.formats.length) return true;
                        return m.formats.some(f => supported.has(f));
                    });
                }
            }

            if (q) {
                models = models.filter(m =>
                    m.model_id.toLowerCase().includes(q)
                );
            }

            return models;
        },

        get selectedModelIds() {
            return this.selectedModels.map(m => m.model_id);
        },

        toggleModel(model) {
            const idx = this.selectedModels.findIndex(m => m.model_id === model.model_id);
            if (idx >= 0) {
                this.selectedModels.splice(idx, 1);
            } else {
                this.selectedModels.push({ ...model });
            }
        },

        addCustomModel() {
            const path = this.customModelPath.trim();
            if (!path) return;
            if (this.selectedModels.some(m => m.model_id === path)) return;
            this.selectedModels.push({
                model_id: path,
                path: path,
                source: 'custom',
                size_bytes: 0,
                formats: [],
            });
            this.customModelPath = '';
        },

        get agentName() {
            if (!this.form.agent_id) return '';
            const caps = this.agentCapabilities[this.form.agent_id];
            return caps ? caps.name : this.form.agent_id;
        },

        isCompatible(model, engineName) {
            const engineFmts = this.engineFormats[engineName] || [];
            if (!model.formats || !model.formats.length) return true;
            if (!engineFmts.length) return true;
            return model.formats.some(f => engineFmts.includes(f));
        },

        get canAdvance() {
            switch (this.step) {
                case 0: return !!this.form.name.trim();
                case 1: return !!this.form.agent_id;
                case 2: return this.form.engines.length > 0;
                case 3: return this.selectedModels.length > 0;
                default: return true;
            }
        },

        formatSize(bytes) {
            if (!bytes) return '';
            const gb = bytes / (1024 * 1024 * 1024);
            return gb >= 1 ? gb.toFixed(1) + ' GB' : (bytes / (1024 * 1024)).toFixed(0) + ' MB';
        },

        async submitCampaign() {
            this.submitting = true;

            const config = {
                campaign_name: this.form.name,
                description: this.form.description,
                models: this.selectedModels.map(m => ({
                    name: m.model_id,
                    path: m.path || m.model_id,
                    estimated_size_gb: m.size_bytes ? +(m.size_bytes / (1024 ** 3)).toFixed(2) : 0,
                })),
                engines: this.form.engines.map(e => ({
                    name: e,
                    suite: this.form.suite,
                })),
                devon_managed: this.form.devon_managed,
                disk: {
                    cleanup_after_run: this.form.cleanup_after_run,
                },
            };

            try {
                const resp = await fetch('/api/v1/campaigns/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        name: this.form.name,
                        description: this.form.description,
                        config: config,
                        agent_id: this.form.agent_id,
                    }),
                });
                const data = await resp.json();
                if (data.id) {
                    window.location.href = '/campaigns/' + data.id;
                } else {
                    alert(data.error || 'Failed to create campaign');
                    this.submitting = false;
                }
            } catch (e) {
                alert('Failed to connect to server: ' + e.message);
                this.submitting = false;
            }
        },
    };
}
</script>
{% endblock %}
