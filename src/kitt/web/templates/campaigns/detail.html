{% extends "base.html" %}
{% block title %}KITT - Campaign: {{ campaign.name }}{% endblock %}

{% block content %}
<div class="space-y-6"
     x-data="campaignDetail()"
     x-init="init()">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold">{{ campaign.name }}</h1>
            {% if campaign.description %}
            <p class="text-kitt-dim text-sm mt-1">{{ campaign.description }}</p>
            {% endif %}
        </div>
        <div class="flex items-center space-x-3">
            <span x-text="currentStatus"
                  :class="{
                      'bg-blue-900/50 text-blue-300': currentStatus === 'running',
                      'bg-green-900/50 text-green-300': currentStatus === 'completed',
                      'bg-red-900/50 text-red-300': currentStatus === 'failed',
                      'bg-yellow-900/50 text-yellow-300': currentStatus === 'queued',
                      'bg-gray-800 text-gray-400': !['running','completed','failed','queued'].includes(currentStatus),
                  }"
                  class="text-xs px-3 py-1 rounded-full font-medium"></span>

            {% if campaign.status == 'draft' %}
            <button hx-post="/api/v1/campaigns/{{ campaign.id }}/launch" hx-swap="none"
                    hx-confirm="Launch this campaign?"
                    class="bg-green-600 hover:bg-green-500 text-white px-4 py-1.5 rounded-md text-sm transition-colors">
                Launch
            </button>
            {% elif campaign.status in ('queued', 'running') %}
            <button hx-post="/api/v1/campaigns/{{ campaign.id }}/cancel" hx-swap="none"
                    hx-confirm="Cancel this campaign?"
                    class="bg-red-600 hover:bg-red-500 text-white px-4 py-1.5 rounded-md text-sm transition-colors">
                Cancel
            </button>
            {% endif %}

            <form action="/campaigns/{{ campaign.id }}/delete" method="POST"
                  onsubmit="return confirm('Delete this campaign?')">
                <button type="submit" class="text-red-400 hover:text-red-300 text-sm">Delete</button>
            </form>
        </div>
    </div>

    <!-- Stats -->
    {% if campaign.total_runs > 0 %}
    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
        <div class="bg-kitt-surface rounded-lg p-4 text-center">
            <div class="text-2xl font-bold">{{ campaign.total_runs }}</div>
            <div class="text-kitt-dim text-xs">Total Runs</div>
        </div>
        <div class="bg-kitt-surface rounded-lg p-4 text-center">
            <div class="text-2xl font-bold text-green-400">{{ campaign.succeeded }}</div>
            <div class="text-kitt-dim text-xs">Succeeded</div>
        </div>
        <div class="bg-kitt-surface rounded-lg p-4 text-center">
            <div class="text-2xl font-bold text-red-400">{{ campaign.failed }}</div>
            <div class="text-kitt-dim text-xs">Failed</div>
        </div>
        <div class="bg-kitt-surface rounded-lg p-4 text-center">
            <div class="text-2xl font-bold text-yellow-400">{{ campaign.skipped }}</div>
            <div class="text-kitt-dim text-xs">Skipped</div>
        </div>
    </div>
    {% endif %}

    <!-- Configuration -->
    <div class="bg-kitt-surface rounded-lg p-5">
        <h2 class="text-lg font-semibold mb-3">Configuration</h2>
        <pre class="bg-kitt-bg rounded-md p-4 text-sm overflow-x-auto text-kitt-dim">{{ campaign.config | tojson(indent=2) }}</pre>
    </div>

    <!-- Timing -->
    <div class="bg-kitt-surface rounded-lg p-5">
        <h2 class="text-lg font-semibold mb-3">Timeline</h2>
        <dl class="space-y-2 text-sm">
            <div class="flex justify-between"><dt class="text-kitt-dim">Created</dt><dd>{{ campaign.created_at[:19] if campaign.created_at else '-' }}</dd></div>
            <div class="flex justify-between"><dt class="text-kitt-dim">Started</dt><dd>{{ campaign.started_at[:19] if campaign.started_at else '-' }}</dd></div>
            <div class="flex justify-between"><dt class="text-kitt-dim">Completed</dt><dd>{{ campaign.completed_at[:19] if campaign.completed_at else '-' }}</dd></div>
        </dl>
    </div>

    {% if campaign.error %}
    <div class="bg-red-900/30 border border-red-700 rounded-lg p-4">
        <h2 class="text-sm font-semibold text-red-300 mb-1">Error</h2>
        <pre class="text-sm text-red-200 whitespace-pre-wrap">{{ campaign.error }}</pre>
    </div>
    {% endif %}

    <!-- Live log stream -->
    <div class="bg-kitt-surface rounded-lg p-5">
        <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-semibold">Logs</h2>
            <div class="flex items-center gap-2">
                <template x-if="isActive">
                    <span class="flex items-center gap-1.5">
                        <span x-show="sseConnected" class="w-2 h-2 rounded-full bg-green-400" title="SSE connected"></span>
                        <span x-show="!sseConnected" class="w-2 h-2 rounded-full bg-yellow-400 animate-pulse" title="Connecting..."></span>
                        <span class="text-xs text-kitt-dim">Live</span>
                    </span>
                </template>
            </div>
        </div>
        <div x-ref="logContainer"
             class="bg-kitt-bg rounded-md p-4 h-64 overflow-y-auto font-mono text-xs text-kitt-dim space-y-0.5">
            <template x-for="(line, i) in logLines" :key="i">
                <div x-text="line"></div>
            </template>
            <div x-show="logLines.length === 0" class="text-kitt-dim">
                <span x-show="isActive">Waiting for logs...</span>
                <span x-show="!isActive">No log lines recorded.</span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function campaignDetail() {
    return {
        campaignId: '{{ campaign.id }}',
        currentStatus: '{{ campaign.status }}',
        logLines: [],
        sseConnected: false,
        _eventSource: null,

        get isActive() {
            return ['queued', 'running'].includes(this.currentStatus);
        },

        init() {
            if (this.isActive) {
                this._connectSSE();
            }
        },

        _scrollToBottom() {
            this.$nextTick(() => {
                const el = this.$refs.logContainer;
                if (el) el.scrollTop = el.scrollHeight;
            });
        },

        _connectSSE() {
            if (this._eventSource) {
                this._eventSource.close();
            }

            const url = '/api/v1/events/stream/' + this.campaignId;
            const es = new EventSource(url);
            this._eventSource = es;

            es.onopen = () => {
                this.sseConnected = true;
            };

            es.addEventListener('log', (e) => {
                const data = JSON.parse(e.data);
                this.logLines.push(data.line || data.message || '');
                this._scrollToBottom();
            });

            es.addEventListener('status', (e) => {
                const data = JSON.parse(e.data);
                const newStatus = data.status || '';
                if (newStatus && newStatus !== this.currentStatus) {
                    this.currentStatus = newStatus;
                    this.logLines.push('[status] ' + newStatus);
                    this._scrollToBottom();
                }
                if (newStatus === 'completed' || newStatus === 'failed') {
                    es.close();
                    this.sseConnected = false;
                }
            });

            es.onerror = () => {
                this.sseConnected = false;
                if (!this.isActive) {
                    es.close();
                }
            };
        },
    };
}
</script>
{% endblock %}
